input_boolean:
  bed_under_light_enabled:
    name: Enable bed under only
    initial: off
    icon: mdi:toggle-switch

  bedroom_door_sensor_enabled:
    name: Enable bedroom door sensor
    initial: off
    icon: mdi:toggle-switch


automation:
  - id: motion_detected_turn_on_bed_lights
    trigger:
      platform: state
      entity_id: binary_sensor.motion_sensor_158d0001225132
      from: 'off'
      to: 'on'
    condition:
      condition: or
      conditions:
        - condition: sun
          after: sunset
          after_offset: "-01:00:00"
        - condition: sun
          before: sunrise
          before_offset: "-00:30:00"
    action:
      - service: light.turn_on
        data:
          entity_id: light.bed_under
      - condition: state
        entity_id: input_boolean.bed_under_light_enabled
        state: 'off'
      - service: light.turn_on
        data:
          entity_id: light.bed_lights

  - id: no_motion_for_30_minutes_turn_off_bedroom_lights
    trigger:
      platform: state
      entity_id: binary_sensor.motion_sensor_158d0001225132
      from: 'on'
      to: 'off'
      for:
        minutes: 30
    action:
      service: light.turn_off
      data:
        entity_id: light.bed_lights

  - id: notify_when_bedroom_door_opens
    trigger:
      platform: state
      entity_id: binary_sensor.door_window_sensor_158d00018311c8
      from: 'off'
      to: 'on'
    condition:
      condition: state
      entity_id: input_boolean.bedroom_door_sensor_enabled
      state: 'on'
    action:
      - service: notify.telegram_admin
        data:
          message: 'Bedroom door opened'

  - id: turn_on_bedroom_door_sensor_when_leaving_home
    trigger:
      - platform: zone
        entity_id: device_tracker.taras_phone
        zone: zone.home
        event: leave
      - platform: zone
        entity_id: device_tracker.ludos_phone
        zone: zone.home
        event: leave
    condition:
      condition: and
      conditions:
        - condition: state
          entity_id: device_tracker.taras_phone
          state: 'not_home'
        - condition: state
          entity_id: device_tracker.ludos_phone
          state: 'not_home'
    action:
      - service: input_boolean.turn_on
        data:
          entity_id: input_boolean.bedroom_door_sensor_enabled

  - id: turn_off_bedroom_door_sensor_when_entering_home
    trigger:
      - platform: zone
        entity_id: device_tracker.taras_phone
        zone: zone.home
        event: enter
      - platform: zone
        entity_id: device_tracker.ludos_phone
        zone: zone.home
        event: enter
    condition:
      condition: or
      conditions:
        - condition: state
          entity_id: device_tracker.taras_phone
          state: 'home'
        - condition: state
          entity_id: device_tracker.ludos_phone
          state: 'home'
    action:
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.bedroom_door_sensor_enabled

  - id: turn_on_bed_under_light_only_at_23_30
    trigger:
      platform: time
      at: '23:30:00'
    action:
      - service: input_boolean.turn_on
        data:
          entity_id: input_boolean.bed_under_light_enabled

  - id: turn_off_bed_under_light_only_at_08_00
    trigger:
      platform: time
      at: '08:00:00'
    action:
      - service: input_boolean.turn_off
        data:
          entity_id: input_boolean.bed_under_light_enabled


group:
  bed_sensors:
    name: Bed Sensors
    entities:
      - binary_sensor.motion_sensor_158d0001225132 # Bedroom
      - input_boolean.bed_under_light_enabled
  bedroom_door:
    name: Bedroom door
    entities:
     - binary_sensor.door_window_sensor_158d00018311c8 # bedroom door
     - input_boolean.bedroom_door_sensor_enabled
